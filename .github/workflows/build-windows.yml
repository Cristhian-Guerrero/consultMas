# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GitHub Actions Workflow - CompilaciÃ³n AutomÃ¡tica Windows .exe
# A.S. Contadores & Asesores SAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ—ï¸ Build Windows Executable

# â•â•â• CUÃNDO SE EJECUTA â•â•â•
on:
  push:
    branches: [ main, master ]  # Cuando hagas push a main/master
    tags:
      - 'v*'                     # O cuando crees un tag tipo v1.0.0
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:             # O manualmente desde GitHub

# â•â•â• TRABAJOS A EJECUTAR â•â•â•
jobs:
  build:
    name: ğŸ“¦ Compilar para Windows
    runs-on: windows-latest      # Usa Windows Server (gratis en GitHub)
    
    steps:
    # â”€â”€â”€â”€â”€â”€â”€ PASO 1: Descargar cÃ³digo â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    # â”€â”€â”€â”€â”€â”€â”€ PASO 2: Instalar Python â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'              # Cachear pip para mÃ¡s velocidad
    
    # â”€â”€â”€â”€â”€â”€â”€ PASO 3: Mostrar info (debug) â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” InformaciÃ³n del sistema
      run: |
        python --version
        pip --version
        echo "Sistema operativo: ${{ runner.os }}"
        echo "Arquitectura: ${{ runner.arch }}"
    
    # â”€â”€â”€â”€â”€â”€â”€ PASO 4: Instalar dependencias â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list
    
# â”€â”€â”€â”€â”€â”€â”€ PASO 5: Compilar con PyInstaller â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”¨ Compilar aplicaciÃ³n a .exe
      run: |
        python -m pyinstaller --clean --noconfirm `
          --name="ConsultaDIAN" `
          --windowed `
          --onefile `
          --add-data="logo.png;." `
          --hidden-import=DrissionPage `
          --hidden-import=pandas `
          --hidden-import=openpyxl `
          --hidden-import=xlsxwriter `
          --hidden-import=PIL `
          --hidden-import=pygetwindow `
          --collect-all DrissionPage `
          --collect-all pandas `
          app.py
    
    # â”€â”€â”€â”€â”€â”€â”€ PASO 6: Verificar que se creÃ³ â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Verificar compilaciÃ³n
      run: |
        if (Test-Path "dist\ConsultaDIAN.exe") {
          Write-Host "âœ… Archivo .exe creado exitosamente"
          Get-Item "dist\ConsultaDIAN.exe" | Format-List
        } else {
          Write-Host "âŒ ERROR: No se creÃ³ el archivo .exe"
          exit 1
        }
    
    # â”€â”€â”€â”€â”€â”€â”€ PASO 7: Crear Release automÃ¡tico â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¤ Crear GitHub Release
      if: startsWith(github.ref, 'refs/tags/')  # Solo si es un tag
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/ConsultaDIAN.exe
        body: |
          ## ğŸš€ Consulta DIAN - A.S. Contadores & Asesores SAS
          
          ### ğŸ“‹ VersiÃ³n: ${{ github.ref_name }}
          
          **Compilado automÃ¡ticamente en Windows Server**
          
          ### ğŸ“¥ Instrucciones de instalaciÃ³n:
          1. Descarga `ConsultaDIAN.exe`
          2. Ejecuta el archivo (no requiere instalaciÃ³n)
          3. Si Windows SmartScreen pregunta, click "MÃ¡s informaciÃ³n" â†’ "Ejecutar de todas formas"
          
          ### âœ¨ CaracterÃ­sticas:
          - âœ… Consulta BÃ¡sica DIAN
          - âœ… Consulta Detallada RUT
          - âœ… Procesamiento masivo Excel/CSV
          - âœ… GeneraciÃ³n automÃ¡tica de reportes
          
          ---
          ğŸ¢ **A.S. Contadores & Asesores SAS**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # â”€â”€â”€â”€â”€â”€â”€ PASO 8: Subir como artifact (siempre) â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“ Subir ejecutable como artifact
      uses: actions/upload-artifact@v4
      with:
        name: ConsultaDIAN-Windows-${{ github.sha }}
        path: dist/ConsultaDIAN.exe
        retention-days: 30  # Guardar 30 dÃ­as
